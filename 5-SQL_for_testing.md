# SQL
- Язык структурированных запросов
- Основной интерфейс работы с реляционными БД
- Декларативный ЯП
- Содержит набор операторов DDL, DML, DCL, TCL (подмножества)
## Подмножества SQL
__DDL__ – язык описания данных
- CREATE – создания объектов БД
- ALTER – изменения объектов БД
- DROP – удаления объектов БД

__DML__ – язык манипулирования данных
- SELECT – выборка данных
- INSERT – добавляет новые данные
- UPDATE – изменяет сущ. данные
- DELETE – удаляет данные

__DCL__ – язык управления доступом к данным
- GRANT – предоставляет разрешения на определённые операции с объектом
- REVOKE – отзывает выданные разрешения
- DENY – задаёт запрет, имеющий приоритет над разрешением

__TCL__ - язык управления транзакциями
- BEGIN TRANSACTION – служит для определения начала транзакции
- COMMIT TRANSACTION – применяет транзакцию
- ROLLBACK TRANSACTION – откатывает все изменения, сделанные в контексте текущей транзакции
- SAVE TRANSACTION – устанавливает промежуточную точку сохранения внутри транзакции

## Реляционная БД, СУБД
__Реляционная БД.__ Четкая структура, данные организованны в виде таблиц, таблицы связанны между собой первичным и вторичным ключом.

__СУБД.__ Система управления базами данных. Специальное программное обеспечение.

## Первичный, внешний, уникальный ключ
- __Первичный ключ (Primary key).__ Поле в таблице, которое идентифицирует каждую строку. Должны содержать уникальные значения. Null значения не допускаются.
- __Внешний (вторичный) ключ (Foreign key).__ Это поле в таблице, ссылающееся на первичный ключ в другой таблице. Используется для связывания двух таблиц.
- __Уникальный ключ (Unique key).__ Идентифицирует строку. Допустимо множество уникальных ключей. Допустимы NULL-значения.

---
__Три оператора в SQL.__
- Арифметические;
- Логические;
- Операторы сравнения.

__Порядок команд:__ FROM+JOIN – WHERE – GROUP BY – HAVING – SELECT – ORDER BY – LIMIT.

__Типы связей в БД.__
- Один к одному;
- Один ко многим;
- Многие ко многим.

__Таблица и поле в таблице.__
- __Таблица__ — организованный набор данных в виде строк и столбцов. 
- __Поле__ — это столбцы в таблице. 
- __Пример:__ Таблица: *Student_Information*. Поле: *Stu_Id, Stu_Name*.

__Значение NULL__ – значение недоступно, неизвестно, присвоено или неприменимо. Значение NULL не равно нулю или пробелу. Ноль — это число, а пробел — символ.

## Типы соединения в SQL
- __(INNER) JOIN.__ Возвращает совпадающие записи из обеих таблиц
- __FULL JOIN.__ Возвращает все записи из обеих таблиц. Записи, не имеющие совпадений - NULL
- __LEFT JOIN.__ Возвращает совпадающие записи из обеих таблиц плюс все записи из левой таблицы
- __RIGHT JOIN.__ Возвращает совпадающие записи из обеих таблиц плюс все записи из правой таблицы
- __CROSS JOIN.__ Перекрестное объединение, каждая с каждым. Условие объединения не указывается
- __UNION.__ Горизонтальное объединение. Одинаковое кол-во столбцов, типы данных и порядок.

## Виды СУБД
__Вариант ответа 1. Два типа СУБД:__
- Реляционная
- Нереляционная

__Вариант ответа 2. Три типа СУБД:__
- Реляционные
- Сетевые и иерархические. Данные организованы в виде иерархии/сети
- Big Data, NoSQL. Данные в неструктурированном виде на распределенном кластере серверов

__Вариант ответа 3. Восемь типов СУБД:__
- Реляционные
- Flat File
- Иерархические
- Сетевые
- Объектно-ориентированные
- Объектно-реляционные
- Многомерная модель
- Гибридные

## Ограничения
Правила для ограничения типа данных при создании или изменении таблицы. Ограничения на выполнение операций с целью сохранения согласованности данных в базе.
- __UNIQUE__ - гарантирует уникальность значений в столбце
- __NOT NULL__ - значение не может быть NULL
- __INDEX__ - создаёт индексы в таблице для быстрого поиска/запросов
- __CHECK__ - значения столбца должны соответствовать заданным условиям
- __DEFAULT__ - значения по умолчанию
- __PRIMARY KEY__ - первичный ключ
- __FOREIGN KEY__ - вторичный ключ

## DELETE, DROP, TRUNCATE
__DROP__ удаляет таблицу, __DELETE__ удаляет с условием, __TRUNCATE__ удаляет.
- __DROP__. Удаляет таблицу из базы данных целиком, вместе со структурой. После команды обратитьcя к удаленной таблице нельзя. DDL-операция. *DROP TABLE table_name;*
- __DELETE__. Удаляет записи из таблицы, с заданным условием (WHERE). Медленнее, чем TRUNCATE. Операцию можно отменить. DML-операция. *DELETE FROM table_name WHERE condition;*
- __TRUNCATE__. Удаляет данные, которые таблица содержит. Нельзя использовать WHERE. Не сканирует таблицу. Быстрее DELETE. Очистка большого количество строк. Нельзя отменить (в SQL Server Rollback можно). DDL-операция. *TRUNCATE TABLE table_name;*

## CRUD
Четыре базовые функции при работе с БД.
- CREATE (создание) – INSERT INTO
- READ (чтение) – SELECT
- UPDATE (изменение) – UPDATE
- DELETE (удаление) – DELETE

## Сущности и отношения
- __Сущности:__ человек, место или объект в реальном мире, данные о которых могут храниться в БД.
- __Отношения:__ связи между сущностями, которые имеют какое-то отношение друг к другу.

## Типы данных в SQL
- Числовые (bit, int, float, real)
- Дата и время (data, time, datatime(2), year)
- Строковые (char, varchar, nchar, nvarchar)
- Бинарные (binary, varbinary)

## Подзапросы
Запрос внутри другого запроса. __Внешний запрос__ называется основным запросом, __внутренний запрос__ - подзапросом. Подзапросы всегда выполняются первыми. __Типы:__
- __Коррелированный подзапрос.__ Зависимый запрос, поскольку ссылается на другую таблицу или столбец в таблице. Выбирает данные из таблицы со ссылкой на внешний запрос. 
- __Некоррелированный подзапрос.__ Независимый запрос, выходные данные подзапроса подставляются в основной запрос.

## Что такое нормализация и денормализация
__Нормализация.__ Устранение избыточности. Эффективная организация данных. Нет дублирования. БД компактнее. Удобнее работать. Гибче. Безопаснее. Больше таблиц с небольшими строками. Легче модифицировать. Согласованность данных после внесения изменений.

__Нормальные формы, виды:__ первая, вторая, третья формы; нормальная форма Бойса-Когга; четвертая, пятая формы; доменно-ключевая; шестая форма.
- __Первая нормальная форма:__ нет дублирующийся строк, все атрибуты атомарны (атрибут содержит несколько значений через запятую), нет повторяющихся атрибутов с одинаковым смыслом.
- __Вторая нормальная форма:__ отношения находятся в первой НФ, есть первичный ключ, все неключевые атрибуты функционально зависят от ключа целиком, но не от его части.
- __Третья нормальная форма:__ отношения находятся во второй НФ, неключевые атрибуты напрямую зависят только от первичного ключа, но не от других атрибутов.

__Денормализация__. Обратный процесс. Избыточность. Можно выбирать данные без использования JOIN’ов. Можно использовать индексы.

## CHAR, VARCHAR 
Типы данных, предназначены для хранения алфавитно-цифровых данных.

CHAR | VARCHAR
---|---
Имеет фиксированную длину	| Использует строки переменной длины
Хранилище фиксированной величины	| Хранилище переменного размера
Занимает от 1 до 4 байт на каждый символ в зависимости от установленной коллации	| Занимает от 1 до 4 байт на каждый символ в зависимости от установленной коллации и одного или более байт для хранения длины данных
Лучше производительность	| Хуже производительность
Строки дополняется пробелами, если их длина меньше фиксированного размера	| Нет необходимости в дополнении пробелами

__NVARCHAR__ хранит значения в формате Unicode, __VARCHAR__ - ASCII

## Индексы
Позволяет быстрее извлекать записи из таблицы. __Три типа индексов:__
1. __Уникальный индекс.__ Не позволяет полю иметь повторяющиеся значения. 
2. __Кластеризованный индекс.__ Меняет физический порядок таблицы и выполняет поиск на основе значений ключа. Каждая таблица может иметь только один кластеризованный индекс. Простой и быстрый. Изменяет способ хранения записей в БД - сортирует строки по столбцу.
3. __Некластеризованный индекс.__ Не изменяет физический порядок таблицы и поддерживает логический порядок данных. Каждая таблица может иметь несколько индексов. Относительно медленный. Не меняет способ хранения данных в БД.

__Целостность данных__ определяет точность и согласованность данных, хранящихся в БД.

## ACID
Используется для обеспечения надежной обработки транзакций данных в системе БД.
- __Атомарность.__ Последовательность команд. Должны быть (не)выполнены все полностью.
- __Согласованность.__ Гарантирует, что данные должны соответствовать всем правилам валидации.
- __Изолированность.__ Контроль механизма параллельного изменения данных.
- __Долговечность.__ Если транзакция была подтверждена, то изменения сохранятся в любом случае.

## Триггер в SQL
Особый тип хранимых процедур, которые предназначены для автоматического выполнения в момент или после изменения данных. Позволяет выполнить пакет кода.

## Транзакции
Последовательность команд. Должны быть (не)выполнены все полностью.
- Начало транзакции. *START TRANSACTION (PostgreSQL)*, автоматическая фиксация транзакций (Oracle).
- Завершение транзакции. *COMMIT* - фиксация, *ROLLBACK* – откат.

## Представления (VIEW)
Псевдонимы для запросов SELECT, используется как аналоги таблиц, не содержат данных. __Использование представлений__ – ограничение доступа к данным, псевдонимы для сложных запросов, сокрытие реализации. __Материализованные представления__ – содержат данные, повышают скорость выполнения запросов.


# Базовые команды
__SELECT__ - возвращает информацию из таблицы 
```
SELECT * FROM table_name;
```

__DISTINCT__ - возвращает только неповторяющиеся данные из таблицы
```
SELECT DISTINCT col_name1, col_name2 FROM table_name;
```

__INSERT INTO__ - добавление данных в таблицу
```
INSERT INTO table_name (col_name1, col_name2, col_name3) VALUES (value1, value2, value3);
```

__UPDATE__ - команда для обновления данных таблицы. __For update__ - тоже самое но ручками
```
UPDATE table_name SET col_name1 = value1, col_name2 = value2, ... WHERE condition;
```

__ORDER BY ASC__ - сортировка по возрастанию, __ORDER BY DESC__ - сортировка по убыванию
```
SELECT * FROM user ORDER BY name DESC;
```

__LIKE__ - специальные символы в шаблонах
- __%__ - любое кол-во символов (включая 0), 
- _ - ровно один символ.
```
WHERE col_name LIKE «%Blond%»;
```

__GROUP BY__ - группировка, используется с агрегатными функциями (COUNT, MAX, MIN, SUM, AVG)
```
SELECT col_name1, col_name2, …
FROM table_name
GROUP BY col_namex;
```

__HAVING__ - используется вместе с группировкой, WHERE использовать нельзя 
```
SELECT COUNT(course_id), dept_name
FROM course
GROUP BY dept_name
HAVING COUNT(course_id)>1; 
```

__JOIN__ - используется для связи двух и более таблиц с помощью общих атрибутов внутри них
```
SELECT col_name1, col_name2, …
FROM table_name1
JOIN table_name2
ON table_name1.col_namex = table2.col_namex;
```

__DELETE__ - используется для удаления данных из таблицы. __TRUNCATE__ - операция мгновенного удаления всех строк в таблице. __DROP__ - удалить всю таблицу целиком.
```
DELETE FROM table_name;
TRUNCATE TABLE table_name;
DROP TABLE table_name;
```

__Агрегатные функции__ – математические функции 
- __SUM__ возвращает сумму; 
- __COUNT__ количество строк; 
- __AVG__ среднее значение; 
- __MIN__ наименьшее значение; 
- __MAX__ наибольшее значение; 
- __NVL__ (1, 2) если значение 1 пустое, берет 2; 
- __VAR__ отличающееся значение.

# Практика
1. Выбрать записи с нечётными Id. 
```
SELECT * FROM sample WHERE id % 2 != 0;
```

2. Выберите только уникальные имена. 
```
SELECT DISTINCT name FROM users;
```

3. Средняя зарплата работников. 
```
SELECT AVG(salary) FROM workers;
```

4. Способы получения количества записей в таблице
```
SELECT * FROM table1;
SELECT COUNT(*) FROM table1;
SELECT rows FROM sysindexes WHERE id = OBJECT_ID(table1) AND indid < 2;
```

5. Получите список сотрудников с зарплатой выше средней
```
SELECT * FROM workers
WHERE salary > (SELECT AVG (salary) FROM workers);
```

6. Подстановочные знаки. Специальные символы для замены каких-либо знаков в запросе. Используются вместе с LIKE, с помощью него можно отфильтровать запрашиваемые данные.
Подстановочные знаки бывают: % заменить ноль или более символов; _ заменить один символ.
```
SELECT * FROM user WHERE name LIKE '%test%'; возврат пользователей, которые содержат «test».
SELECT * FROM user WHERE name LIKE 't_est'; начинаются на «t», заканчивается на «est».
```

7. Псевдонимы Aliases. Временное имя таблицы или столбца. Существует на время запроса.
```
SELECT very_long_column_name AS alias_name FROM table;
```

8. Переименование таблицы. ALTER TABLE можно добавлять, удалять, изменять столбцы, изменять название таблицы. 
```
ALTER TABLE first_table RENAME second_table;
```

9. Найти дубли в поле email
```
SELECT email, COUNT(email) 
FROM customers
GROUP BY email
HAVING COUNT(email) > 1;
```

10. Даны таблицы workers и departments. Найдите все департаменты без единого сотрудника
```
SELECT department_name
FROM workers w
RIGHT JOIN departments d ON (w.department_id = d.department_id)
WHERE first_name IS NULL;
```

11. Замените в таблице зарплату работника на 1000, если она равна 900, и на 1500 в ост. случаях
```
UPDATE table SET salary =
CASE
WHEN salary = 900 THEN 1000
ELSE 1500 END;
```
Вопросы с собеседований должны быть более развёрнутыми. Уточните, что после UPDATE следует указать, какие записи должны быть обновлены. В данном случае обновятся все записи в таблице.

12. При выборке из таблицы прибавьте к дате 1 день
```
SELECT DATE_ADD(date, 1 DAY) AS new_date FROM table;
```
Функция DATE_ADD() прибавляет к дате заданный промежуток времени.
SELECT DATE_ADD(дата, INTERVAL что_прибавить) FROM имя_таблицы WHERE условие;

13. При выборке из таблицы пользователей создайте поле, которое будет включать в себя и имена, и зарплату. Функция CONCAT() используется для конкатенации (объединения) строк, неявно преобразуя при этом любые типы данных в строки.
```
SELECT CONCAT(name, salary) AS new_field FROM users;
```

14. Что такое Self JOIN?
Это выражение используется для того, чтобы таблица объединилась сама с собой, словно это две разные таблицы. Чтобы такое реализовать, одна из таких «таблиц» временно переименовывается.
Следующий SQL-запрос объединяет клиентов из одного города:
```
SELECT A.CustomerName AS CustomerName1, B.CustomerName AS CustomerName2, A.City
FROM Customers A, Customers B
WHERE A.CustomerID <> B.CustomerID
AND A.City = B.City
ORDER BY A.City;
```

15. Для чего оператор INSERT INTO SELECT? Данный оператор копирует данные из одной таблицы и вставляет их в другую, при этом типы данных в обеих таблицах должны соответствовать.
```
INSERT INTO second_table
SELECT * FROM first_table
WHERE condition;
```

16. Вывести с 10 по 15 строки:
```
SELECT * FROM employee OFFSET 10 LIMIT 5; 
SELECT * FROM employee OFFSET 10 FETCH FIRST 5 ROW ONLY;
```

17. Вывести сотрудников, которые живут в Китае, России и Израиле:
```
SELECT * FROM employee WHERE country_of_birth = ‘China’ OR country_of_birth = ‘Russia’
OR country_of_birth = ‘Israel’;
```

Короче: 
```
SELECT * FROM employee WHERE country_of_birth IN (‘China’, ‘Russia’, ‘Israel’);
```

18. Вывести сотрудников, которые родились с 1990 по 1995 года:
```
SELECT * FROM employee WHERE date_of_birth BETWEEN ‘1990-01-01’ AND ‘1995-01-01’;
```

19. Вывести сотрудников, у которых почта заканчивается на «.com»:
```
SELECT * FROM employee WHERE email LIKE ‘%.com’; - регистрозависимый
```

20. Посчитать сотрудников в каждой стране: страна, кол-во сотрудников.
```
SELECT country_of_birth, COUNT(*) FROM employee GROUP BY country_of_birth;
```

21. Посчитать сотрудников в каждой стране, вывести те страны, в которых сотрудников больше 10: страна, кол-во сотрудников. 
```
SELECT country_of_birth, COUNT(*) FROM employee GROUP BY country_of_birth HAVING COUNT(*) > 10;
```

22. Найти самые дорогие города: страна, город, максимальная цена.
```
SELECT country, city, MAX(price) FROM holiday GROUP BY country, city; 
```

23. Вывести сумму путевок в каждую страну: страна, общая сумма.
```
SELECT country SUM(price) FROM holiday GROUP BY country; 
```

24. Добавить первичный ключ к полю id (если забыли это сделать при создании таблицы):
```
ALTER TABLE employee ADD PRIMARY KEY(id);
```

25. Добавить первичный ключ: 
```
id BIGSERIAL NOT NULL PRIMARY KEY;
```